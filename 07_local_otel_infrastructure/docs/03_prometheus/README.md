# Prometheus

## Prometheus とは

Prometheus は時系列データベースおよびモニタリングシステム。メトリクスデータを保存し、強力なクエリ言語 (PromQL) で分析できる。この構成では Alloy から Remote Write 経由でメトリクスを受信し、同時に Alloy 自身のメトリクスもスクレイプする。

## なぜ Prometheus を採用したか

- **PromQL:** メトリクスのクエリ言語として業界標準。レート計算、集約、ヒストグラム分位数の算出など、柔軟な分析が可能
- **Grafana との統合:** ネイティブデータソースとしてサポートされており、Tempo のサービスマップ生成にも Prometheus のメトリクスが使われる
- **エコシステムの広さ:** アラートルール、レコーディングルールなど、本番運用に必要な機能が揃っている

## 設定ファイル

- パス: `_docker/prometheus/prometheus.yml`

## 各ブロックの解説

### `global`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
```

| パラメータ            | 値    | 説明                                                                              |
| --------------------- | ----- | --------------------------------------------------------------------------------- |
| `scrape_interval`     | `15s` | Prometheus がターゲットからメトリクスを取得 (スクレイプ) する間隔                 |
| `evaluation_interval` | `15s` | アラートルールの評価間隔 (この構成では未使用だが、グローバルデフォルトとして必須) |

**なぜ 15 秒なのか:** Prometheus のデフォルト値。ローカル開発ではメトリクスの更新頻度がそこまで高くないため、デフォルトのまま十分。間隔を短くするとストレージ消費が増え、長くすると変化の検出が遅れるためバランスが重要。

### `scrape_configs`

```yaml
scrape_configs:
  - job_name: alloy
    static_configs:
      - targets:
          - alloy:12345
```

Prometheus が能動的にスクレイプするエンドポイントを定義する。

| パラメータ | 値            | 説明                                                                 |
| ---------- | ------------- | -------------------------------------------------------------------- |
| `job_name` | `alloy`       | このターゲットから取得した全メトリクスに付与されるラベル             |
| `targets`  | `alloy:12345` | Alloy の管理エンドポイント。Alloy 自身の内部メトリクスを公開している |

**なぜアプリではなく Alloy をスクレイプするのか:** アプリケーションメトリクス (Go から送信される OTLP メトリクス) は Alloy の Remote Write 経由でプッシュされるため、Prometheus がスクレイプする必要はない。ここでスクレイプしているのは Alloy 自身の内部メトリクス (処理したスパン数、エラー率など) であり、テレメトリパイプラインの健全性を監視するためのもの。

## メトリクスの流れ

```text
アプリ (Go) → [Alloy OTLP 受信] → [Alloy Remote Write] → Prometheus (プッシュ)
Alloy 内部メトリクス ← Prometheus が alloy:12345 をスクレイプ (プル)
```

Prometheus は 2 つのモードを同時に使用している。

1. **プッシュ** — Alloy から Remote Write API 経由でアプリケーションメトリクスを受信 (docker-compose の `--web.enable-remote-write-receiver` フラグで有効化)
2. **プル** — 15 秒ごとに Alloy の内部メトリクスをスクレイプ

**なぜプッシュとプルを併用するのか:** アプリ側のメトリクスは OTLP (プッシュ型) で統一したいが、Alloy 自身は Prometheus 形式のメトリクスエンドポイントを公開しているため、従来のプル型で取得する方が自然。それぞれのデータ提供元に合った方法を使い分けている。

## 公開ポート

| ポート | プロトコル | 用途                         |
| ------ | ---------- | ---------------------------- |
| 9090   | HTTP       | Prometheus Web UI および API |
