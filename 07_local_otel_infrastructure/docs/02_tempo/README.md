# Grafana Tempo

## Tempo とは

Grafana Tempo は分散トレースのバックエンドストレージ。OTLP 経由で受信したトレースデータを保存し、Grafana からクエリ可能にする。Jaeger や Zipkin と異なり、外部のインデックス用データベースが不要で、トレース ID のみでインデックスする設計。

## なぜ Tempo を採用したか

- **インデックス用 DB が不要:** Jaeger は Elasticsearch や Cassandra を別途必要とするが、Tempo はオブジェクトストレージ (またはローカルファイル) だけで動作する。ローカル開発環境の構成がシンプルになる
- **Grafana との統合:** Tempo は Grafana にネイティブ対応しており、トレース → ログ / メトリクスへの相互参照が設定だけで実現できる
- **コスト効率:** トレース ID のみのインデックスに割り切ることで、全スパンをインデックスする Jaeger と比較してストレージコストが低い

## 設定ファイル

- パス: `_docker/tempo/tempo.yaml`

## 各ブロックの解説

### `stream_over_http_enabled: true`

HTTP 経由でトレース結果をストリーミングする機能を有効化。大きなトレースを全件取得するのを待たずに Grafana 上で逐次描画できるようになる。

**なぜ有効にするのか:** スパン数が多いトレース (数百〜数千スパン) を表示する際、全データの取得完了を待つと Grafana の表示が遅くなる。ストリーミングにより体感速度が向上する。

### `server`

```yaml
server:
  http_listen_port: 3200
```

Tempo の HTTP API がポート 3200 でリッスンする。Grafana はこのエンドポイントを使ってトレースをクエリする。

**なぜ 3200 番なのか:** Tempo のデフォルトポート。他のサービス (Grafana: 3000, Loki: 3100) と衝突しない番号が割り当てられている。

### `distributor`

```yaml
distributor:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
```

トレースデータの受信方法を設定する。

| パラメータ     | 値             | 説明                                       |
| -------------- | -------------- | ------------------------------------------ |
| プロトコル     | gRPC           | gRPC 経由で OTLP トレースを受信            |
| エンドポイント | `0.0.0.0:4317` | 全インターフェースのポート 4317 でリッスン |

この構成では Alloy がこのエンドポイントにトレースを転送する。

**なぜ gRPC のみで HTTP は不要なのか:** Tempo に直接トレースを送るのは Alloy だけであり、Alloy は gRPC で通信する。不要なプロトコルを開けない方がセキュリティ面でも望ましい。

### `storage`

```yaml
storage:
  trace:
    backend: local
    local:
      path: /var/tempo/traces
    wal:
      path: /var/tempo/wal
```

| パラメータ   | 値                  | 説明                                                                                                                    |
| ------------ | ------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `backend`    | `local`             | ローカルファイルシステムにトレースを保存 (開発環境向け)                                                                 |
| `local.path` | `/var/tempo/traces` | 確定済みトレースブロックの保存先                                                                                        |
| `wal.path`   | `/var/tempo/wal`    | Write-Ahead Log。受信したトレースをストレージにフラッシュするまでバッファリングする。クラッシュ時のデータ損失を防止する |

**なぜ `local` バックエンドなのか:** ローカル開発環境では S3 や GCS を用意する必要がなく、Docker Volume にそのまま書き込める `local` が最もシンプル。本番環境では `s3` や `gcs` を使い、耐久性とスケーラビリティを確保する。

**なぜ WAL が必要なのか:** トレースは受信後すぐにストレージに書き込むのではなく、一定量をまとめてブロック化する。WAL はその間のデータを保持し、プロセスが異常終了してもデータを復元できるようにする仕組み。

## 公開ポート

| ポート | プロトコル | 用途                                       |
| ------ | ---------- | ------------------------------------------ |
| 3200   | HTTP       | Tempo クエリ API (Grafana が使用)          |
| 4317   | gRPC       | OTLP 受信 (内部通信のみ、ホストには非公開) |
