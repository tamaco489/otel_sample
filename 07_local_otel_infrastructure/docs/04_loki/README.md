# Grafana Loki

## Loki とは

Grafana Loki はログ集約システム。Elasticsearch と異なり、ログの全文をインデックスせず、ラベル (メタデータ) のみをインデックスする。そのため軽量かつ低コストで、クエリ時には全文検索も可能。

## なぜ Loki を採用したか

- **軽量さ:** Elasticsearch はログ全文をインデックスするため、大量のメモリとストレージが必要になる。Loki はラベルのみのインデックスで済むため、ローカル開発環境でも軽快に動作する
- **Grafana スタックとの統合:** Tempo (トレース) → Loki (ログ) の相互参照が設定だけで実現できる。`trace_id` をラベルにしておけば、トレース画面からワンクリックで対応ログへ遷移可能
- **LogQL:** Prometheus の PromQL に似たクエリ言語で、ラベルフィルタと全文検索を組み合わせた柔軟なログ検索が可能

## 設定ファイル

- パス: `_docker/loki/loki.yaml`

## 各ブロックの解説

### `auth_enabled: false`

マルチテナント認証を無効化する。シングルテナントのローカル開発環境では `X-Scope-OrgID` ヘッダーが不要になる。

**なぜ無効にするのか:** マルチテナント認証が有効だと、すべての API リクエスト (Alloy からのプッシュ、Grafana からのクエリ) に `X-Scope-OrgID` ヘッダーを付与する必要がある。ローカル開発では単一テナントで十分なため、ヘッダー管理の手間を省く。

### `server`

```yaml
server:
  http_listen_port: 3100
```

Loki の HTTP API がポート 3100 でリッスンする。Alloy がこのエンドポイントにログをプッシュし、Grafana がここからログをクエリする。

### `common`

```yaml
common:
  path_prefix: /loki
  storage:
    filesystem:
      chunks_directory: /loki/chunks
      rules_directory: /loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory
```

| パラメータ           | 値             | 説明                                                       |
| -------------------- | -------------- | ---------------------------------------------------------- |
| `path_prefix`        | `/loki`        | Loki の全データのベースディレクトリ                        |
| `chunks_directory`   | `/loki/chunks` | 圧縮されたログチャンクの保存先                             |
| `rules_directory`    | `/loki/rules`  | アラート/レコーディングルールの保存先 (この構成では未使用) |
| `replication_factor` | `1`            | レプリケーションなし。単一インスタンス、開発環境向け       |
| `ring.kvstore.store` | `inmemory`     | ハッシュリングにインメモリ KV ストアを使用                 |

**なぜ `replication_factor: 1` なのか:** Loki は分散構成で複数インスタンスを動かす場合にレプリケーションでデータの冗長性を確保する。ローカル開発は単一インスタンスのため、レプリケーションは不要。

**なぜ `inmemory` KV ストアなのか:** ハッシュリングは分散構成でインスタンス間の調整に使う仕組み。単一インスタンスでは自分自身の情報を保持するだけなので、永続化が不要なインメモリで十分。本番の分散構成では `consul` や `etcd` を使う。

### `schema_config`

```yaml
schema_config:
  configs:
    - from: "2024-01-01"
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h
```

ログのインデックスと保存方法を定義する。

| パラメータ     | 値           | 説明                                            |
| -------------- | ------------ | ----------------------------------------------- |
| `from`         | `2024-01-01` | この日付以降の全ログにこのスキーマを適用        |
| `store`        | `tsdb`       | インデックスに TSDB (時系列データベース) を使用 |
| `object_store` | `filesystem` | ログチャンクをローカルファイルシステムに保存    |
| `schema`       | `v13`        | 最新のスキーマバージョン                        |
| `index.prefix` | `index_`     | インデックステーブル名のプレフィックス          |
| `index.period` | `24h`        | 24 時間ごとに新しいインデックステーブルを作成   |

**なぜ `tsdb` ストアなのか:** Loki 3.x で推奨されるインデックスストア。旧来の `boltdb-shipper` と比較してクエリ性能が向上しており、新規構築なら `tsdb` を選ぶのが標準。

**なぜ `filesystem` なのか:** ローカル開発では S3 や GCS を用意する必要がなく、Docker Volume にそのまま書き込める。本番環境ではオブジェクトストレージに変更する。

**なぜ `v13` スキーマなのか:** `tsdb` ストアを使うために必須のバージョン。新規構築のため古いスキーマとの互換性を気にする必要がなく、最新版を採用している。

**なぜ `24h` 周期なのか:** インデックステーブルの粒度を決めるパラメータ。24 時間ごとにテーブルを分割することで、古いログの削除 (リテンション) をテーブル単位で効率的に行える。Loki の推奨値。

## 公開ポート

| ポート | プロトコル | 用途                     |
| ------ | ---------- | ------------------------ |
| 3100   | HTTP       | Loki プッシュ/クエリ API |
